# HTTP/2.0
> 8번째 초안 기반

## 등장 배경
- HTTP/1.1의 성능 문제
    * 1.1의 메시지 포맷은 구현의 단순성, 접근성에 최적화됨
    * 심각한 회전 지연
    * 병렬 커넥션/파이프라인 커넥션 -> 임시 방편
- 여러 단체의 개선 노력... 구글의 SPDY 프로토콜
    * 기존 HTTP + 속도 개선용 여러 기능
    * 헤더 압축 -> 대역폭 절약
    * 하나의 TCP 커넥션에 여러 요청을 동시에 보냄 -> 회전 지연 줄임
    * 클라이언트가 요청을 보내지 않아도 서버가 능동적으로 리소스 푸시


## 개요
1. 클라이언트가 초기화하는 클라이언트-서버 간 TCP 커넥션 위에서 동작
2. 요청과 응답은 길이가 정의된 한 개 이상의 프레임에 담기며, 헤더는 압축됨
3. 프레임에 담긴 요청과 응답은 스트림으로 보내짐
    * 한 개의 스트림: 한 쌍의 요청과 응답
    * 하나의 커넥션 위 여러 개의 스트림 가능
    * 스트림의 흐름 제어, 우선순위 부여 기능 제공
4. 요청-응답 + 서버 푸시
    * 서버는 클라이언트에게 필요하다고 생각되는 리소스를 별도 요청 없이 보낼 수 있음
5. 기존 웹앱과의 호환성 유지
    * 응답 메시지의 의미를 1.1과 같게 함
    * 문법 변경 (ex. `Content-Length` -> `:content-length`)


## HTTP/1.1과의 차이점
1. 프레임
    - 모든 메시지는 프레임에 담겨 전송
    - 데이터 (DATA), 헤더 (HEADERS), 우선순위 (PRIORITY), 스트림 리셋 (RST_STREAM), SETTINGS, PUSH_PROMISE 등 총 10가지
2. 스트림과 멀티플렉싱
    - 스트림? HTTP/2.0 커넥션을 통해 클라-서버 간 교환되는 프레임들의 독립된 양방향 시퀀스
    - 한 쌍의 HTTP 요청과 응답은 하나의 스트림을 통해 이루어짐
    - 1.1에서는 TCP 커넥션을 유지하기 위해 응답이 도착했어야 했으나, 2.0에서는 하나의 커넥션에 여러 스트림이 동시에 열릴 수 있다.
    - 스트림은 우선 순위를 가질 수 있다 (의무는 아님)
    - 스트림은 일방적으로 만듦 (협상 불필요)
    - 스트림 식별자는 재사용 불가 / 고갈될 경우 다시 커넥션 맺음
        * 클라이언트가 만들면 홀수, 서버가 만들면 짝수
        * 스트림 식별자는 점점 증가해야만 함
    - 스트림 블록을 막기 위해 흐름 제어 지원 (?)
3. 헤더 압축
    - 웹페이지 하나를 위한 많은 요청 -> 헤더 크기가 회전 지연, 대역폭에 영향 미침
    - 헤더는 HPACK 명세에 정의된 압축 방법으로 압축 -> 헤더 블록 조각으로 쪼개 전송 -> 해제할 때 압축 콘텍스트 변경
    - HPACK 압축에는 '압축 콘텍스트'가 사용되므로 오동작 방지를 위해 같은 콘텍스트 유지 필요 
        * 각 피어에서 압축을 해제한다고 기대 -> 안 쓰더라도 헤더 압축 해제 필요
        * 그럴 수 없다면 COMPRESSION_ERROR (커넥션 에러, 종료)
4. 서버 푸시
    - 2.0에서는 서버가 하나의 요청에 대해 응답으로 여러 개의 리소스를 보낼 수 있게 함 (서버가 클라이언트가 요구할 것을 미리 알 경우 유용)
    - `PUSH_PROMISE`: 서버가 클라이언트에게 자원을 푸시할 것임을 알려줌 -> 클라이언트 수신 시, 스트림 예약됨
        * 클라이언트가 서버가 푸시하려는 리소스를 요청하는 상황을 피하기 위함
    - `RST_STREAM`: 클라이언트가 서버의 푸시를 거절함 -> 스트림 닫힘
    - 중간의 프록시가 서버 푸시의 의도와는 별개로 원치 않는 전송 / 원치 않는 미전송이 이루어질 수 있음
    - 안전하고 캐시 가능하고 본문을 포함하지 않는 요청에 대해서만 푸시 가능
    - 푸시할 리소스는 클라이언트가 명시적으로 보낸 것과 연관이 있어야만 함
    - 클라는 서버가 푸시한 리소스를 CORS에 따라 검사해야 함. = 다른 origin 에서 온 리소스는 거부해야 함.
    - 서버 푸시를 끄고 싶다면 SETTING_ENABLE_PUSH = 0 으로 설정
    - [Introducing HTTP/2 Server Push with NGINX 1.13.9](https://www.nginx.com/blog/nginx-1-13-9-http2-server-push/)


## 알려진 보안 이슈