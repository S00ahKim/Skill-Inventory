# Service
- 쿠버네티스의 네트워크 담당
- 파드 IP가 부여되는데 왜 필요한가? 안정성 때문
    * 파드 = 불안정한ephemeral 자원 / 언제든지 종료될 수 있음 / 엔드포인트가 불안정하고 계속 추적해야함
    * 서비스 = 파드 생명주기와 무관한 엔드포인트 제공 / 파드 앞단에서 트래픽을 파드로 전달하는 리버스 프록시 역할
        + cf. 프록시 = 클라숨김, 리버스 프록시 = 서버숨김
- 생성
    ```yaml
    apiVersion: v1
    kind: Service
    metadata:
      labels:
        hello: world
      name: ex-svc
    spec:
      ports:                # 서비스의 포트들
      - port: 8080          # 서비스로 들어오는 포트
        protocol: TCP       # 사용하는 프로토콜 (ex. TCP, UDP, HTTP)
        targetPort: 80      # 트래픽을 전달할 컨테이너의 포트
      selector:             # 트래픽을 전달할 컨테이너의 라벨
        run: ex-nginx
    ```
- 서비스 탐색
    * 서비스 리소스의 이름 기반 DNS 참조 가능
        + 이름 법칙: `{서비스_이름}.{네임스페이스}.svc.cluster.local`
        + svc.cluster.local 부분은 쿠버네티스 클러스터 도메인으로, 변경할 수 있지만 보통 기본값으로 사용함
        + 클러스터 도메인 주소는 생략 가능하며, 생략된 부분은 디폴트로 채움
    * 라벨 셀렉터를 이용하여 파드를 선택
        + 파드의 이름을 직접 참조할 경우, 파드 생명주기에 따라 매번 서비스 내용이 변경되어야 함
        + 라벨링으로 간접 참조(느슨한 연결)할 경우, 그 라벨을 가진 어떤 파드에든 트래픽 전달 가능하므로 서비스를 매번 변경해줄 필요 없음
    * 탐색 순서
        1. 도메인 호출
        2. DNS Resolver가 도메인에 맞는 클러스터IP 호출 (= kube-dns 서비스의 IP)
        3. kube-dns가 coredns를 사용하여 요청된 도메인에 맞는 IP 주소 얻음
        4. 사용자에게 응답이 돌아감
    * 모든 파드들은 클러스터 내부, 외부 DNS 질의를 coredns를 통해 수행함
- 서비스 타입
    * YAML 파일의 spec 하위 프로퍼티
    * ClusterIP
        + 디폴트
        + 이 타입의 서비스 엔드포인트는 클러스터 내부에서만 접근 가능
        + 네트워크 보안 및 관리를 위해 직접 트래픽을 받는 엔드포인트 최소화
        + 다른 복잡한 네트워크 기능의 뼈대가 되어줌
    * NodePort
        + 도커 컨테이너 포트 매핑과 유사
        + 호스트(노드)의 특정 포트 - 서비스의 특정 포트 연결
        + 노드포트는 모든 노드에서 동일한 엔드포인트 제공함 (단, externalTrafficPolicy 옵션이 Cluster인 경우)
        + 외부 트래픽을 서비스까지 전달할 수 있음
    * LoadBalancer
        + 노드 앞단에 로드밸런서를 두고 각 노드로 트래픽을 분산할 수 있게 함
        + 퍼블릭 클라우드 플랫폼이 제공하는 로드밸런서를 연결할 수 있음 ex. ELB
        + NodePort 타입은 노드포트 대역을 열어두고 이를 외부에 공개하는 방법이라면, LoadBalancer 타입은 서버를 내부 네트워크에 두고 로드밸런서만 외부 네트워크에 엔드포인트(웰노운포트)를 제공하는 식으로 열어두어 네트워크 보안성을 높임
        + 로드밸런서가 클러스터 앞단에 있으면 사용자는 각각의 서버IP를 몰라도 로드밸런서의 IP/도메인 주소만 갖고도 요청을 보낼 수 있음 (쿠버네티스는 노드 역시 자유롭게 종료시킬 수 있어서 그때마다 노드IP 추적은 번거로움)
            - 즉 ClusterIp가 파드 레벨에서 안정적 엔드포인트를 제공한다면, LoadBalancer 타입 서비스는 노드 레벨에서 안정적 엔드포인트를 제공
    * ExternalName
        ```yaml
        apiVersion: v1
        kind: Service
        metadata:
          name: my-external-service
          namespace: default
        spec:
          type: ExternalName
          externalName: external.example.com
        ``` 
        + 외부 DNS 주소에 대해 클러스터 내부에서 사용할 새로운 별칭을 만듦
        + 위 예시의 경우, external.example.com 에 default 라는 별칭으로 접근 가능
        + 쿠버네티스 클러스터에 편입되지 않는 외부 서비스에 쿠버네티스 네트워킹 기능을 연결하고 싶을 때 사용
- 쿠버네티스 네트워크 모델의 특징
    * 모든 리소스가 다른 모든 리소스를 (ex. 노드-노드, 파드-파드, 노드-파드) NAT 없이 고유 IP로 통신이 가능하다
        + cf. 쿠버네티스 전신인 Borg 프로젝트는 NAT를 사용했는데 포트 충돌이 빈번해서 번거로웠기 때문에 독립적 네트워크 환경을 구성함
    * 각 파드는 고유 IP를 할당받는다
    * 파드IP에 클러스터 내부 어디서든 접근 가능하다 (에이전트도 마찬가지) 호스트 서버와의 종속성이 없다