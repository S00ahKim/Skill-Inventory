# 부하 분산(로드 밸런싱, Load Balancing)
- 정의: 여러 대의 서버들로 대규모 네트워크 트래픽을 분산 처리하는 기술
- 역할: 한 곳의 End Point로 들어오는 트래픽을 각각의 컴퓨팅 장치에 분산시킨다.


## 왜?
- 한 대의 서버로 감당하기 어려운 트래픽이 발생할 경우, Scale-up 방식에 한계가 있기 때문
- Scale-up? 한 대의 서버의 성능을 높이는 것
- Sclae-out? 여러 대의 서버를 추가하여 시스템을 확장하는 것


## 동작 방식
1. 클라이언트의 브라우저에서 도메인 이름을 입력
2. 클라이언트의 메인 DNS에서 도메인 네임에 해당하는 IP 주소를 질의
3. 메인 DNS 서버에서 해당 도메인 네임을 가진 DNS 서버에 IP 주소를 질의
4. 그 DNS 서버에서 로드밸런서의 virtual IP 주소(VIP)를 메인 DNS 서버에 응답
5. 메인 DNS 서버에서 클라이언트에게 VIP를 응답
6. 클라이언트에서 로드밸런서의 VIP로 http 요청
7. 로드밸런서는 연동된 서버에게 별도의 알고리즘(ex. 라운드 로빈)으로 요청
8. 로드밸런서가 서버에게 응답을 받아, 클라이언트에게 응답


## 기본 기능
1. Health Check
    - 헬스 체크? 감시대상이 정상인 상태에 있는지 여부를 확인하는 것
    - 역할
        * 보유한 서버들에 대해 주기적으로 헬스 체크를 하여 장애 여부를 판단할 수 있음
        * 서버에 이상이 생겨도 fail over 가능
        * TCP/UDP 분석을 할 수 있는 방화벽 역할 수행 가능
    - 어떻게?
        * L3: ICMP로 서버의 IP 주소가 통신 가능한 상태인지 확인
        * L4: TCP의 3-way handshake의 특성을 바탕으로 포트 상태 확인
        * L7: 애플리케이션 계층에서 상태 확인. 실제 페이지에 요청

2. Tunneling
    - 터널링? 한 네트워크에서 다른 네트워크로 데이터를 이동할 수 있는 것 (by 캡슐화)
    - 클라이언트와 서버 사이에 로드밸런서가 터널링을 제공. 연결된 상호간 캡슐화된 패킷을 구별하여 패킷 해제.

3. NAT (Network Addressing Translation)
    - NAT? IP 패킷의 TCP/UDP 포트 숫자와 소스 및 목적지의 IP 주소 등을 재기록하면서 라우터를 통해 네트워크 트래픽을 주고 받는 기술
    - 역할
        * 부족한 공인 IP 주소를 효율적으로 사용 가능
        * 여러 개의 호스트가 하나의 VIP로 접속하게 함
    - 어떻게?
        * 내부 네트워크의 사설 IP 주소 <-> 로드밸런서 외부의 공인 IP 주소
        * SNAT (내부->외부) ex. 공유기
        * DNAT (외부->내부) ex. 로드밸런서

4. DSR (Direct Server Return)
    - DSR? 로드밸런서 부하를 줄이기 위해 outbound 패킷이 로드밸런서를 거치지 않고 바로 클라이언트에게 전달되게 하는 기술


## L4 (Classic Load Balancer, a.k.a. Connection Load Balancer, Session Load Balancer)
- 계층적 특성? 라우터, 스위치 등 물리적인 하드웨어 영역을 다루므로, 데이터를 변경하거나 수정할 수 없음.
- 기준: 네트워크 계층, 전송 계층의 정보 바탕으로 부하 분산. (ex. IP 주소, port, MAC 주소, 전송 프로토콜)
- 장점: 데이터 안을 보지 않고 패킷 레벨에서 부하 분산을 하기 때문에 속도가 빠르고 효율이 높음. L7보다 저렴.
- 단점: 섬세한 라우팅을 하기 어려움.
- 알고리즘
    * 라운드 로빈: 순차적으로 세션 맺음. 경우에 따라 같은 처리량을 보장하지 않음.
    * 가중치/비율 할당: 서버마다 비율을 정하고 그 비율만큼 세션 맺음. 성능 좋으면 많이.
    * 최소 연결 기반: 가장 적은 세션을 가진 서버로 트래픽 보냄. 
    * 응답 시간 기반: 가장 빠른 응답을 보내는 서버로 트래픽 보냄. 가용 리소스, 처리하는 데이터량이 상이할 때 적합.
    * 해시 기반: 특정 클라이언트는 특정 서버에만 할당.
    * 대역폭 기반: 서버들과의 대역폭을 고려하여 트래픽 분산.


## L7 (Application Load Balancer)
- 계층적 특성? 응용 계층이기 때문에 포트나 헤더를 수정할 수 있음.
- 기준: L4의 기준을 포함, 7계층 프로토콜인 HTTP, FMTP, FTP등을 기준으로도 부하 분산 가능.
- 장점: 사용자 요청을 기준으로 부하 분산 가능. 즉 패킷 내용을 확인해서 분산하는 게 가능. 섬세한 라우팅. 비정상적 트래픽 필터링 가능.
- 단점: 패킷 내용을 복호화하기 때문에 L4보다 비용이 높음.
- 알고리즘
    * URL 스위칭: 특정 url은 특정 서버로 처리
    * 컨텍스트 스위칭: 특정 리소스는 특정 서버로 처리
    * 쿠키 지속성: 쿠키 정보로 클라이언트가 연결했던 동일 서버에 할당


## GSLB (Global Server Load Balancing)
- 언제? 같은 동작을 하고, 같은 서비스를 제공하는 서버들이 여러 지역에 분리되어 완전히 다른 네트워크에서 운용될 때 이용.
- 사용? GSLB+SLB 형태로 혼합 사용된다.
- SLB와의 차이? SLB의 경우, VIP 기반으로 로드밸런싱한다. GSLB는 DNS 기반으로 로드밸런싱한다.
- DNS와의 차이? 일반적인 DNS는 서버나 네트워크의 상태를 전혀 고려하지 않음. GSLB는 서버 헬스 등을 기준으로 서버를 선택함.


## 성능 지표
1. 초당 연결 수 (connection per second): 최대 연결 가능한 초당 TCP 세션 수
2. 동시 연결 수 (concurrent connections): 동시에 최대로 세션 유지할 수 있는 수
3. 처리용량 (throughput): 패킷 자체로 연결하는 UDP에 대한 로드밸런싱 지표. FWLB에서 중요함. 단위는 bps, pps.


## 기타 용어 정리
- load balancer? 로드밸런싱 기술을 제공하는 서비스/장치. 클라이언트와 서버풀/네트워크허브 사이에 존재함.
- server pool? 동일한 응용 프로그램을 구성하고 실행하는 하나 이상의 서버 군.
- network hub? 여러 대의 네트워크 장비를 연결하는 장치. 같은 허브 내의 장비는 상호간 통신이 가능함.
- DNS (Domain Name Server)? 호스트의 도메인 이름을 호스트의 네트워크 주소로 바꾸거나 그 반대의 변환을 수행함


## 참고자료
- [Steven J. Lee - 네트워크의 부하분산, 로드밸런싱 그리고 로드밸런서](https://www.stevenjlee.net/2020/06/30/%ec%9d%b4%ed%95%b4%ed%95%98%ea%b8%b0-%eb%84%a4%ed%8a%b8%ec%9b%8c%ed%81%ac%ec%9d%98-%eb%b6%80%ed%95%98%eb%b6%84%ec%82%b0-%eb%a1%9c%eb%93%9c%eb%b0%b8%eb%9f%b0%ec%8b%b1-load-balancing-%ea%b7%b8/)
- [VMWare Docs - 로드밸런싱을 위한 서버 풀 추가](https://docs.vmware.com/kr/VMware-NSX-T-Data-Center/2.3/com.vmware.nsxt.admin.doc/GUID-E60ACBCF-C8C4-462A-9167-9BF71194FC9C.html)
- [AWS 로드밸런싱 알아보기](https://medium.com/harrythegreat/aws-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1-%EC%95%8C%EC%95%84%EB%B3%B4%EA%B8%B0-9fd0955f859e)