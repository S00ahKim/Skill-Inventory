# Docker Swarm

## 1. 개념
- 도커 기반으로 **서버 클러스터링** (여러 대의 도커 서버를 하나의 클러스터로 구성)
- 비교적 간단
- 도커와 통합됨(기본 설치) 다른 툴 설치할 필요 없고, 명령어 공유


## 2. 용어
- `스웜swarm`: 클러스터
- `노드node`: 스웜 클러스터에 속한 도커 서버의 단위. 
  * 보통 한 서버에 하나의 도커데몬만 실행하므로 서버가 곧 노드. 
  * 매니저 노드와 워커 노드가 있다.
    + `매니저 노드`: **스웜 클러스터 상태**를 관리
     - 매니저 노드는 곧 워커노드가 될 수 있고 스웜 명령어는 매니저 노드에서만 실행
     - 워커 노드에 컨테이너를 배포하는 스케줄링 수행 (스케줄러는 컨테이너를 생성할 노드를 선정하고, 분산 할당)
    + `워커 노드`: 매니저 노드의 명령을 받아 컨테이너를 **생성하고 실행하며 상태를 체크**
- `서비스service`: 기본적인 배포 단위
  * 도커는 컨테이너 단위로, 스웜 모드는 서비스 단위로 제어
  * 하나의 서비스는 하나의 이미지 기반으로 생성
  * <동일한> 컨테이너 한개 이상 실행 가능 (역할/종류가 같은 컨테이너)
  * 컨테이너는 스케줄러에 의해 매니저 또는 워커 노드에 분산 할당됨
- `서비스 레플리카`: 생성된 컨테이너
  * 복제할 수를 지정할 수 있음
  * 지속적으로 모니터링. 개수 모자라면 새로 생성, 서버 다운, 동작 정지, 롤링 업데이트
- `태스크task`: 컨테이너 배포 단위
  * 하나의 서비스는 여러개의 테스크를 실행할 수 있음
  * 각각의 테스크가 컨테이너를 관리


## 3. 제공 기능
- 분산 코디네이터 Zookeeper
- 스케줄링
  * 서비스를 만들고, 워커 노드에 **컨테이너를 배포**하는 것
  * 특정 노드에만 배포 가능
  * 모든 서버에 한 대씩 배포하는 글로벌 기능 제공
  * 서비스별로 CPU, 메모리 사용량 미리 설정 가능
- 오토 스케일링
  * 개수가 모자라면 새로 생성 가능
  * 하지만 기본적으로 리밸런싱, 오토 스케일링을 지원하는 것은 아님
- 복제 (레플리카 --replicas )
  * 서비스 모드가 **<복제>**와 **<글로벌>**이 있음. 
  * 각각이 독립된 컨테이너이므로, 몇 개를 생성하든 상관 없음
  * **글로벌**은 노드별로 하나 이상 생성, 레플리카 수 지정 안 함, 모니터링용
- 고가용성
  * 매니저 노드: **Raft 합의(Consensus) 알고리즘**(여러 서버 중 일부에 장애가 생겨도 나머지 서버가 정상적인 서비스를 할 수 있도록 하고, `전체 서비스를 중단하지 않고도 복구`할 수 있는 것)으로 리더를 선출(**election**)하여 클러스터의 **상태를 유지**. 이 때문에 매니저 노드는 **홀수**로 구성할 것을 권장함.
- 롤링 업데이트
  * 서비스가 계속 진행되어야 하는 서비스에서 **중단 없이 부분적 업데이트**
  * 순차적 업데이트. 서비스를 새로운 이미지로 업데이트하는 경우 하나 하나 차례대로 업데이트함.
  * 동시에 업데이트하는 작업의 개수와 업데이트 간격 시간을 조정 가능.
- 로드밸런싱 (ingress network)
  * 정적 로드밸런싱. **라운드 로빈** 방식으로 컨테이너 접근.
  * 도커 스웜은 서비스를 외부에 쉽게 노출하기 위해 모든 노드가 ingress라는 가상 네트워크에 속함.
  * **ingress**: routing mesh (서비스가 포트를 오픈할 경우 모든 노드에 포트가 오픈 & 어떤 노드에 요청을 보내도 실행 중인 컨테이너에 자동으로 전달)