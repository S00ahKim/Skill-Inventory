# Kubernetes

## 1. 개념
- 컨테이너화된 프로세스를 관리(ex. 라이프사이클)하기 위한 컨테이너 오케스트레이션 플랫폼
- 구글이 만들고 리눅스 재단 산하의 CNCF가 관리함


## 2. 장점
- 서비스 배포와 운영에 필요한 기능 지원
    * 서비스 디스커버리와 로드 밸런싱
    * 롤아웃/롤백/bin 패킹/복구 자동화
- 성능, 안정성, 확장성(커스텀, 다른 도구들과의 연동)
    * 고가용성? 프로덕션 환경에서는 컨트롤 플레인이 여러 컴퓨터에서 실행 & 클러스터가 여러 노드를 실행되기 때문
    * 벤더/플랫폼에 종속되지 않음 & 대부분의 퍼블릭 클라우드(구글,AWS,Azure)등에 사용 가능 & 베어메탈에도 배포 가능


## 3. 아키텍처 & 컴포넌트
![cc_02_01](../images/cc_02_01.svg)

- 쿠버네티스를 배포하면 `클러스터`를 얻는다
- 클러스터는 하나 이상의 `노드`라는 worker를 가진다

### 노드 (=worker)
* 역할
  + 애플리케이션의 구성요소인 `파드pod`(클러스터에서 실행 중인 컨테이너 집합)를 호스트 (컨테이너화된 애플리케이션을 실행)
  + 마스터로부터 명령을 전달 받아 서비스
  + 동작 중인 파드를 유지 & 쿠버네티스 런타임 환경을 제공

* 컴포넌트
  + `kubelet`
     - 마스터의 명령에 따라 컨테이너의 라이프 사이클을 관리하는 노드 관리자
     - 파드에서 컨테이너가 확실하게 동작하도록 관리하기 위해 클러스터의 각 노드에서 실행되는 에이전트
  + `kube-proxy`: 클러스터의 각 노드에서 실행되는 네트워크 프록시
     - 쿠버네티스 네트워킹 서비스를 용이하게 하기 위한 네트워크 프록시
     - OS의 패킷 필터링 계층에 의존하거나 트래픽 자체를 전달하여 클러스터 내부 또는 외부의 네트워크 통신을 처리
  + `컨테이너 런타임`: 컨테이너 실행을 담당하는 소프트웨어. (ex. Docker)


### 컨트롤 플레인 (=master)
* 역할
  + 워커 노드와 클러스터 내 파드 관리
  + 클러스터 전반적인 결정 & 클러스터 이벤트 감지 및 반응

* 컴포넌트
  + `kube-apiserver`: 프론트 엔드. 쿠버네티스 API를 노출.
     - REST 호출이나 kubectl 커맨드라인 인터페이스 또는 kubeadm과 같은 기타 CLI를 통해 접근 
  + `etcd`
     - 모든 클러스터 (메타)데이터를 담는 쿠버네티스 뒷단의 key-value 저장소
     - 데이터 동기화를 담당하는 분산 코디네이터
  + `kube-scheduler`: 노드가 배정되지 않은 새로 생성된 파드를 감지하고, 실행할 노드를 선택.
  + `kube-controller-manager`
     - 현재 상태를 원하는 상태로 만드는 컨트롤 프로세스를 실행 및 모니터링
     - 특정 이벤트에 따라 특정 동작을 수행
     - 여러 컨트롤러 기능이 하나로 통합
     - 스케줄러를 참고하여 요청한 갯수의 파드를 실행
  + `cloud-controller-manager`: 클라우드별 컨트롤 로직.

* 기타
  + `kubectl`: 마스터노드의 CLI로 클러스터 제어 (사용자가 제어, 큐브 컨트롤)


### 4. 쿠버네티스 오브젝트
> 시스템은 오브젝트의 생성을 보장하고, 사용자가 지정한 desired state를 유지하기 위해 지속적으로 작동
- 쿠버네티스는 쿠버네티스 시스템의 영구 엔티티인 `오브젝트`들을 사용하여 클러스터의 상태를 나타낸다.
- 쿠버네티스는 현재 상태를 사용자가 생각하는 최종 배포 상태(`Desired State`)로 변경한다.
- 쿠버네티스 오브젝트롤 동작(생성/수정/삭제)시키려면, 쿠버네티스 API를 이용해야 한다.

1. 개념
    - 하나의 **의도를 담은 레코드**
    - 기본 오브젝트와 컨트롤러로 구성
    - **클러스터 상태**를 나타내기 위해 사용
        - 어떤 컨테이너화된 애플리케이션이 동작 중인지 (그리고 어느 노드에서 동작 중인지)
        - 그 애플리케이션이 이용할 수 있는 리소스
        - 그 애플리케이션이 어떻게 재구동 정책, 업그레이드, 그리고 내고장성과 같은 것에 동작해야 하는지에 대한 정책

2. 기본 오브젝트
    - 파드
    - 서비스
    - 볼륨
    - 네임스페이스
        * 쿠버네티스 클러스터 내의 논리적인 분리 단위
        * 네임스페이스 레벨 리소스와 클러스터 레벨 리소스로 구분
        * 네임스페이스별 리소스 할당량을 지정하고, 사용자별로 접근 권한을 다르게 주기 위함

3. 컨트롤러
    - 역할: control-loop를 돌며 특정 리소스를 지속적으로 모니터링 -> 사용자가 생성한 리소스의 이벤트에 따라 사전에 정의된 작업을 수행
    - 종류
        * 레플리카 셋
        * 디플로이먼트
        * 스테이트풀 셋
        * 데몬 셋
        * 잡


### 5. 선언형 커맨드
- 사용자가 직접 시스템의 상태를 바꾸지 않고, 바라는 상태를 선언적으로 기술하여 명령을 내리는 방법
- 선언형 커맨드의 반대 개념은 명령형(Imperative) 커맨드로, SQL 쿼리도 명령형 커맨드의 한 종류
- 쿠버네티스는 `YAML` 형식을 이용하여 선언형 커맨드를 수행
- ```yaml
  apiVersion: v1
  kind: Pod
  metadata:
  name: mypod
    spec:
  containers:
  - name: nginx
    image: nginx:latest
  ```